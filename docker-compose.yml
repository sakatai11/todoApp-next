version: '3.9'
services:
  nextjs:
    build: .
    ports:
      - '3000:3000'
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_MOCKING=disabled
      - FIRESTORE_EMULATOR_HOST=firebase-emulator:8080
      - FIREBASE_AUTH_EMULATOR_HOST=firebase-emulator:9099
    depends_on:
      - firebase-emulator

  firebase-emulator:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    ports:
      - '4000:4000'  # Emulator UI
      - '8080:8080'  # Firestore
      - '9099:9099'  # Auth
      - '5001:5001'  # Functions (将来的に使用可能)
    volumes:
      - .:/workspace
    working_dir: /workspace
    command: >
      sh -c "
        apt-get update && apt-get install -y openjdk-11-jre-headless &&
        gcloud components install firebase-cli --quiet &&
        firebase emulators:start --project=todoapp-next-dev --only=firestore,auth,ui --host=0.0.0.0
      "
    environment:
      - FIRESTORE_EMULATOR_HOST=0.0.0.0:8080
      - FIREBASE_AUTH_EMULATOR_HOST=0.0.0.0:9099
